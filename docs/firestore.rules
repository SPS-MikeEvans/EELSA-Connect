
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user has the 'Admin' role.
    function isAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    // Helper function to check if a user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }

    // Users Collection
    // - Users can read their own data.
    // - Users can be created during sign-up.
    // - Users can update their own fullName.
    // - Admins can read and write any user document.
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if (request.auth.uid == userId && request.resource.data.keys().hasOnly(['fullName'])) || isAdmin();
      allow delete: if isAdmin();
    }

    // Directories Collection
    // - Any signed-in user can read/list directories.
    // - Only admins can create, update, or delete directories.
    match /directories/{directoryId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Resources Collection
    // - Any signed-in user can read/list resources.
    // - Any signed-in user can create a resource (upload).
    // - Only admins can update or delete resources.
    match /resources/{resourceId} {
      allow read, create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // Certificates Collection
    // - Users can only read their own certificates.
    // - Admins can create certificates for any user.
    match /users/{userId}/certificates/{certificateId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if isAdmin();
      allow write: if false; // Certificates are read-only once created.
    }
    
    // Trainings Collection (for dashboard)
    // - Signed-in users can read the list of trainings.
    // - Only admins can write to the trainings collection.
    match /trainings/{trainingId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }

    // Recent Activity Collection (for dashboard)
    // - Signed-in users can read the list of recent activities.
    // - Writes are handled by backend logic (e.g., Cloud Functions or secured server actions),
    //   so direct client writes are disallowed.
    match /recentActivity/{activityId} {
      allow read: if isSignedIn();
      allow write: if false; // Should be written from a trusted server environment.
    }
    
    // Channels and Messages
    // - Users can read/write messages within channels.
    // - Admins have full read access to monitor conversations.
    match /channels/{channelId} {
      allow read, create, update: if isSignedIn();
      
      match /messages/{messageId} {
          allow read, create: if isSignedIn();
      }
    }

    // Collection Group query for messages (for dashboard stats)
    match /{path=**}/messages/{messageId} {
      allow list: if isSignedIn();
    }
  }
}
